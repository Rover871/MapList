<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>MapList</title>
<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=3.0, user-scalable=yes">
    <title>MapList</title>
    <style>
        /* –û–±—â–∏–µ —Å—Ç–∏–ª–∏ */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
        }

        html, body {
            width: 100vw;
            min-width: 0;
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            height: 100vh;
        }

        body {
            overflow: hidden;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .control-panel {
            display: flex;
            padding: 5px;
            background: #f0f0f0;
            border-bottom: 1px solid #ccc;
            flex-wrap: wrap;
            align-items: center;
            gap: 3px;
        }

        .control-panel button, .control-panel input, .control-panel select {
            margin: 0;
            padding: 5px 10px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .workspace {
            flex: 1;
            position: relative;
            overflow: auto !important;
            background: white;
            width: 100vw;
            min-width: 0;
            min-height: 0;
            height: calc(100vh - 80px);
        }

        /* –†–µ–∂–∏–º –∫–∞—Ä—Ç—ã */
        .map-container {
            position: relative;
            width: 100vw;
            height: 100%;
            overflow: auto !important;
            min-width: 0;
            min-height: 0;
            background: white;
        }

        .map-area {
            position: relative;
            width: 5000px;
            height: 5000px;
            background: white;
        }

        .map-object {
            position: absolute;
            min-width: 60px;
            min-height: 60px;
            border: 2px solid #333;
            border-radius: 5px;
            padding: 5px;
            background: #fff;
            cursor: move;
            user-select: none;
        }

        .map-object-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .map-object-title {
            flex: 1;
            font-weight: bold;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .map-object-delete {
            cursor: pointer;
            margin-left: 5px;
            color: rgb(255, 0, 0);
        }

        .map-object-attributes {
            font-size: 0.8em;
            color: #555;
            margin-bottom: 5px;
        }

        .map-object-connector {
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 24px;
            height: 24px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
            text-align: center;
            line-height: 24px;
            font-size: 16px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.10);
            border: 2px solid #fff;
            transition: box-shadow 0.2s, background 0.2s;
        }

        .connection {
            position: absolute;
            pointer-events: auto;
            cursor: pointer;
        }

        .connection-arrow {
            position: absolute;
            width: 0;
            height: 0;
            border-left: 5px solid transparent;
            border-right: 5px solid transparent;
            border-top: 10px solid black;
            transform: translate(-5px, 0);
        }

        /* –†–µ–∂–∏–º —Å–ø–∏—Å–∫–∞ */
        .list-container {
            width: 100%;
            height: 100%;
            overflow-y: auto;
            overflow-x: hidden;
            display: none;
            padding: 10px;
            max-width: 100vw;
        }

        .list-object {
            display: flex;
            border: 1px solid #ddd;
            padding: 10px;
            margin-bottom: 5px;
            background: white;
            align-items: center;
        }

        .list-object-title {
            flex: 1;
            font-weight: bold;
        }

        .list-object-attributes {
            flex: 2;
            display: flex;
            flex-wrap: wrap;
        }

        .list-object .map-object-delete {
            flex-shrink: 0;      /* –ó–∞–ø—Ä–µ—â–∞–µ—Ç –∫–Ω–æ–ø–∫–µ —Å–∂–∏–º–∞—Ç—å—Å—è */
            flex-grow: 0;        /* –ó–∞–ø—Ä–µ—â–∞–µ—Ç –∫–Ω–æ–ø–∫–µ —Ä–∞—Å—Ç—è–≥–∏–≤–∞—Ç—å—Å—è */
            width: 24px;         /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞ */
            height: 24px;        /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ */
            padding: 0;          /* –£–±–∏—Ä–∞–µ—Ç –≤—Å–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –æ—Ç—Å—Ç—É–ø—ã */
            font-size: 1.5em;    /* –ó–∞–¥–∞–µ—Ç —Ä–∞–∑–º–µ—Ä —Å–º–∞–π–ª–∏–∫–∞ */
            display: flex;       /* –ò—Å–ø–æ–ª—å–∑—É–µ—Ç flexbox –¥–ª—è —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è */
            align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
            justify-content: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ—Ç –ø–æ –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª–∏ */
        }

        .list-object-attribute {
            margin-right: 10px;
            font-size: 0.8em;
            color: #555;
        }

         list-object-actions {
            margin-left: 10px;
            /* –≠—Ç–∏ –ø—Ä–∞–≤–∏–ª–∞ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ —Å—É–∑—è—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä */
            flex-shrink: 0; /* –ó–∞–ø—Ä–µ—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É —Ä–∞—Å—à–∏—Ä—è—Ç—å—Å—è */
            flex-grow: 0;   /* –ó–∞–ø—Ä–µ—â–∞–µ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É —Å–∂–∏–º–∞—Ç—å—Å—è */
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .tag {
            display: inline-block;
            background: #e0e0e0;
            padding: 2px 5px;
            border-radius: 3px;
            margin-right: 3px;
            font-size: 0.8em;
        }

        .dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background: white;
            min-width: 120px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1;
            padding: 5px;
        }

        .dropdown-item {
            padding: 3px;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: #f0f0f0;
        }

        /* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            padding: 20px;
            border-radius: 5px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
        }

        .modal-title {
            font-size: 1.2em;
            font-weight: bold;
        }

        .modal-close {
            cursor: pointer;
            font-size: 1.5em;
            line-height: 1;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .form-group input, .form-group textarea, .form-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .tags-container {
            display: flex;
            flex-wrap: wrap;
            margin-bottom: 10px;
        }

        .tag-with-remove {
            display: flex;
            align-items: center;
            background: #e0e0e0;
            padding: 2px 5px;
            border-radius: 3px;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        .tag-remove {
            margin-left: 5px;
            cursor: pointer;
            color: #999;
        }

        .tag-remove:hover {
            color: #f00;
        }

        .modal-footer {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            gap: 10px;
        }

        .modal-footer button {
            flex: 1;
            padding: 12px 20px;
            margin: 0;
            cursor: pointer;
            min-width: 80px;
            min-height: 40px;
            height: 40px;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            border: 1px solid #bbb;
            background: #f8f8f8;
            color: #222;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.01);
            box-sizing: border-box;
        }

        .modal-footer button:hover {
            background: #e8e8e8;
        }

        #move-to-map-btn {
            background-color: #4CAF50 !important;
            color: white !important;
        }

        #move-to-map-btn:hover {
            background-color: #45a049 !important;
        }

        /* –ê–¥–∞–ø—Ç–∏–≤–Ω–æ—Å—Ç—å */
        @media (max-width: 768px) {
            .control-panel {
                flex-direction: row;
                padding: 15px;
                flex-wrap: wrap;
                gap: 5px;
            }

            .control-panel button, .control-panel input, .control-panel select {
                margin: 0;
                padding: 12px 15px;
                font-size: 16px; /* –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ—Ç –∑—É–º –Ω–∞ iOS */
                min-height: 44px; /* –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è touch */
            }

            .app-btn, .control-panel button {
                min-width: 32px;
                min-height: 32px;
                height: 32px;
                padding: 0 8px;
                border-width: 1px !important;
            }
        }

        @media (max-width: 480px) {
            .control-panel {
                padding: 10px;
                flex-wrap: wrap;
                gap: 5px;
            }

            .control-panel button, .control-panel input, .control-panel select {
                padding: 15px 20px;
                font-size: 18px;
            }

            .app-btn, .control-panel button {
                min-width: 90px;
                min-height: 32px;
                height: 32px;
                padding: 0 8px;
                border-width: 1px !important;
            }
        }

        /* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –æ—á–µ–Ω—å –º–∞–ª–µ–Ω—å–∫–∏—Ö —ç–∫—Ä–∞–Ω–æ–≤ */
        @media (max-width: 480px) {
            .control-panel {
                padding: 10px;
            }

            .control-panel button, .control-panel input, .control-panel select {
                padding: 15px 20px;
                font-size: 18px;
            }

            .map-object {
                min-width: 100px;
                min-height: 100px;
                padding: 10px;
            }

            .modal-content {
                width: 98%;
                margin: 5px;
                padding: 20px;
            }

            /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∑—É–º–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö */
            .zoom-controls {
                display: block !important;
            }
        }

        /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –∑—É–º–∞ –Ω–∞ –ø–ª–∞–Ω—à–µ—Ç–∞—Ö */
        @media (max-width: 768px) {
            .zoom-controls {
                display: block !important;
            }
        }

        /* –°—Ç–∏–ª–∏ –¥–ª—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
        #sort-direction {
            width: 40px;
            height: 40px;
            font-size: 1.1em !important;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            margin: 0;
            text-align: center;
            box-sizing: border-box;
        }

        #sort-by {
            text-align: left;
            padding-left: 8px;
            font-size: 1.2em; /* –ò–∑–º–µ–Ω–µ–Ω–æ, —á—Ç–æ–±—ã –Ω–µ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤–∞—Ç—å */
        }

        /* –°—Ç–∏–ª—å –¥–ª—è –≤—ã–¥–µ–ª–µ–Ω–Ω–æ–≥–æ —Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—è */
        .map-object-connector.active {
            background: red;
        }

        .connection svg {
            cursor: pointer;
            transition: filter 0.2s;
        }

        .connection svg:hover {
            filter: drop-shadow(0 0 4px red);
        }

        .add-new-tag-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            margin: 0 0 4px 0;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 22px;
            height: 22px;
            transition: background 0.2s;
        }

        .add-new-tag-btn:hover {
            background: #e0e0e0;
        }

        /* –î–æ–±–∞–≤–ª—è—é —Å—Ç–∏–ª–∏ –¥–ª—è –∫–∞—Å—Ç–æ–º–Ω–æ–≥–æ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –º–µ—Ç–æ–∫ */
        .tags-dropdown-popup {
            position: absolute;
            background: #fff;
            border: 1px solid #ccc;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
            z-index: 1000;
            min-width: 140px;
            padding: 4px 0;
            border-radius: 6px;
            margin-top: 4px;
        }

        .tags-dropdown-popup .dropdown-item {
            padding: 6px 12px;
            cursor: pointer;
            white-space: nowrap;
            transition: background 0.15s;
        }

        .tags-dropdown-popup .dropdown-item:hover {
            background: #f0f0f0;
        }

        .add-tag-plus-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.3em;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background 0.2s;
            margin-left: 4px;
        }

        .add-tag-plus-btn:hover {
            background: #e0e0e0;
        }

        .dropdown-content.show {
            display: block;
        }

        .tags-dropdown-trigger {
            background: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            padding: 2px 8px;
            margin-left: 8px;
        }

        .tags-dropdown-trigger:hover {
            background: #e0e0e0;
        }

        #tags-menu-content .dropdown-item {
            padding: 8px 12px;
        }

        #tags-menu-content .dropdown-separator {
            height: 1px;
            background: #eee;
            margin: 4px 0;
        }

        /* –£–¥–∞–ª—è—é –≤–æ–∑–º–æ–∂–Ω—ã–µ –ø—Å–µ–≤–¥–æ—ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è .tags-dropdown-trigger */
        .tags-dropdown-trigger::before,
        .tags-dropdown-trigger::after {
            content: none !important;
            display: none !important;
        }

        .app-btn, .control-panel button {
            min-width: 50px;
            min-height: 40px;
            height: 40px;
            width: 50px;
            padding: 0 8px;
            font-size: 1em;
            font-weight: 500 !important;
            letter-spacing: 0.01em;
            text-align: center;
            line-height: 1.1;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 2px;
            border: 1px solid #bbb !important;
            border-width: 1px !important;
            background: #f8f8f8;
            color: #222;
            cursor: pointer;
            transition: background 0.2s, box-shadow 0.2s;
            box-shadow: 0 1px 1px rgba(0, 0, 0, 0.01);
            margin: 0;
            box-sizing: border-box;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ –¥–ª—è –ø–æ–ª–µ–π —Å —Ç–µ–∫—Å—Ç–æ–º */
        #search, #filter-date-from, #filter-date-to, #sort-by {
            width: 140px !important;
            min-width: 140px !important;
            max-width: 140px !important;
        }

        .control-panel button, .app-btn {
            width: 50px;
            min-width: 50px;
            max-width: 50px;
        }

        @media (max-width: 768px) {
            .app-btn, .control-panel button {
                min-width: 50px;
                min-height: 40px;
                height: 40px;
                width: 50px;
                padding: 0 8px;
                border-width: 1px !important;
            }

            #search, #filter-date-from, #filter-date-to, #sort-by {
                width: 120px !important;
                min-width: 120px !important;
                max-width: 120px !important;
            }
        }

        @media (max-width: 480px) {
            .app-btn, .control-panel button {
                min-width: 50px;
                min-height: 40px;
                height: 40px;
                width: 50px;
                padding: 0 8px;
                border-width: 1px !important;
            }

            #search, #filter-date-from, #filter-date-to, #sort-by {
                width: 100px !important;
                min-width: 100px !important;
                max-width: 100px !important;
            }
        }
        
        /* –ü—Ä–∞–≤–∏–ª–æ –¥–ª—è –±–æ–ª—å—à–∏—Ö —Å–º–∞–π–ª–∏–∫–æ–≤ —Ç–µ–ø–µ—Ä—å –±–æ–ª–µ–µ —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω–æ, —á—Ç–æ–±—ã –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ —Å—Ä–∞–±–æ—Ç–∞—Ç—å */
        .control-panel .emoji-btn {
            font-size: 2em !important;
            line-height: 1 !important;
        }
    </style>
        <!-- Supabase JS CDN -->
        <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    </head>
<body>
    <!-- –ü–∞–Ω–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ -->
    <div id="auth-panel" style="padding:8px;border-bottom:1px solid #ccc;display:flex;align-items:center;gap:8px;flex-wrap:wrap;">
        <div id="auth-logged-out" style="display:flex;align-items:center;gap:4px;flex-wrap:wrap;">
            <input type="email" id="auth-email" placeholder="Email" style="padding:4px 8px;min-width:180px;">
            <input type="password" id="auth-password" placeholder="–ü–∞—Ä–æ–ª—å" style="padding:4px 8px;min-width:140px;">
            <button id="auth-signup" class="app-btn">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
            <button id="auth-login" class="app-btn">–í—Ö–æ–¥</button>
        </div>
        <div id="auth-logged-in" style="display:none;align-items:center;gap:8px;">
            <span id="auth-user-email" style="font-weight:bold;"></span>
            <button id="auth-logout" class="app-btn">–í—ã–π—Ç–∏</button>
        </div>
    </div>

    <div class="control-panel">
        <button id="add-object" class="app-btn emoji-btn" title="–î–æ–±–∞–≤–∏—Ç—å –æ–±—ä–µ–∫—Ç">üü¢</button>
        <button id="toggle-view" class="app-btn emoji-btn" title="–ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å —Ä–µ–∂–∏–º">üó∫Ô∏è/üìã</button>
        <button id="reset-filters" class="app-btn emoji-btn" title="–°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã">‚ôªÔ∏è</button>
        <div id="filter-tags-container" style="position: relative; display: inline-block;">
            <button id="filter-tags-trigger" class="app-btn emoji-btn" style="padding: 0 2px; border: 1px solid #ccc; background: white; cursor: pointer; min-width: 32px; text-align: center; line-height: 1;">üè∑Ô∏è</button>
            <div id="filter-tags-dropdown" style="display: none; position: absolute; top: 100%; left: 0; background: white; border: 1px solid #ccc; max-height: 200px; overflow-y: auto; z-index: 1000; min-width: 150px;">
                <div style="padding: 5px; border-bottom: 1px solid #eee;">
                    <label style="display: flex; align-items: center; cursor: pointer;">
                        <input type="checkbox" id="filter-all-tags" style="margin-right: 5px; width: 18px; height: 18px;">üè∑Ô∏è
                    </label>
                </div>
                <div id="filter-tags-list"></div>
            </div>
        </div>
        <button id="sort-direction" class="app-btn emoji-btn" title="–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏">‚ñ≤</button>
        <select id="sort-by" class="app-btn" style="display: none; font-size:1.2em; width:140px;">
            <option value="title">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</option>
            <option value="date">–ü–æ –¥–∞—Ç–µ</option>
            <option value="connections">–ü–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —Å–≤—è–∑–µ–π</option>
        </select>
        <input type="date" id="filter-date-from" placeholder="–û—Ç" style="font-size:1.2em; width:130px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
        <input type="date" id="filter-date-to" placeholder="–î–æ" style="font-size:1.2em; width:130px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
        <input type="text" id="search" placeholder="–ü–æ–∏—Å–∫..." style="font-size:1.2em; width:140px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap;">
    </div>
    
    <div class="workspace">
        <div class="map-container">
            <div class="map-area" id="map-area"></div>
            <div class="zoom-controls" style="position: absolute; top: 10px; right: 10px; z-index: 1000; display: none;">
                <button id="zoom-in" style="width: 50px; height: 50px; margin: 5px; font-size: 24px; border-radius: 50%; background: white; border: 2px solid #ccc; cursor: pointer;">+</button>
                <button id="zoom-out" style="width: 50px; height: 50px; margin: 5px; font-size: 24px; border-radius: 50%; background: white; border: 2px solid #ccc; cursor: pointer;">-</button>
            </div>
        </div>
        <div class="list-container" id="list-container"></div>
    </div>
    
    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞</div>
                <div class="modal-close" id="modal-close">&times;</div>
            </div>
            <div class="form-group">
                <div style="display: flex; align-items: center; gap: 8px; z-index: 2; position: relative;">
                    <button type="button" id="manage-tags-open-btn" style="background:none;border:none;color:#1976d2;font-weight:bold;cursor:pointer;padding:0;font-size:1em;z-index:2;">–ú–µ—Ç–∫–∏</button>
                </div>
                <div style="display: flex; align-items: center; flex-wrap: wrap;">
                    <div class="tags-container" id="tags-container"></div>
                </div>
            </div>
            <div class="form-group">
                <label for="edit-title">–ù–∞–∑–≤–∞–Ω–∏–µ:</label>
                <input type="text" id="edit-title">
            </div>
            <div class="form-group">
                <label>–î–∞—Ç–∞ –æ—Ç:</label>
                <input type="date" id="edit-date-from">
            </div>
            <div class="form-group">
                <label>–î–∞—Ç–∞ –¥–æ:</label>
                <input type="date" id="edit-date-to">
            </div>
            <div class="form-group">
                <label>–¶–≤–µ—Ç:</label>
                <div id="color-picker" style="display: flex; gap: 8px; margin-bottom: 8px;"></div>
                <input type="hidden" id="edit-color" value="#FFB3BA">
            </div>
            <div class="form-group">
                <label for="edit-note">–ó–∞–º–µ—Ç–∫–∞:</label>
                <textarea id="edit-note" rows="3" style="width:100%;resize:vertical;"></textarea>
            </div>
            <div class="modal-footer">
                <button id="modal-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="move-to-map-btn" style="display: none; background-color: #4CAF50; color: white;">–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="new-tag-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–ù–æ–≤–∞—è –º–µ—Ç–∫–∞</div>
                <div class="modal-close" id="new-tag-close">&times;</div>
            </div>
            <div class="form-group">
                <label for="new-tag-name">–ù–∞–∑–≤–∞–Ω–∏–µ –º–µ—Ç–∫–∏:</label>
                <input type="text" id="new-tag-name">
            </div>
            <div class="modal-footer">
                <button id="new-tag-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button id="new-tag-close-btn" style="margin-left: 10px;">–ó–∞–∫—Ä—ã—Ç—å</button>
            </div>
        </div>
    </div>
    
    <div class="modal" id="manage-tags-modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∞–º–∏</div>
                <div class="modal-close" id="manage-tags-close">&times;</div>
            </div>
            <div id="manage-tags-list"></div>
            <div class="modal-footer">
                <button id="manage-tags-save">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- Supabase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è ---
        const SUPABASE_URL = 'https://obhaonhhrjzppfemzvlf.supabase.co'; // TODO: –∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –≤–∞—à URL –ø—Ä–æ–µ–∫—Ç–∞
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9iaGFvbmhocmp6cHBmZW16dmxmIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzODQxMzcsImV4cCI6MjA4Mzk2MDEzN30.LtKB6SNFwOBnSp9aYmg0k8p099UPg1-mtSKnqIMnCYQ'; // TODO: –≤—Å—Ç–∞–≤—å—Ç–µ –≤–∞—à anon public key
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        let currentUser = null;

        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
        let objects = [];
        let connections = [];
        let isMapView = false;
        let isDragging = false;
        let isPanning = false;
        let startX, startY;
        let selectedObject = null;
        let creatingConnection = false;
        let connectionStartId = null;
        let scale = 1;
        let offsetX = 0, offsetY = 0;
        let currentEditId = null;
        let sortDirection = 1; // 1 - –ø–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é, -1 - –ø–æ —É–±—ã–≤–∞–Ω–∏—é
        let undoState = null;
        let newObj = null; // <--- –≥–ª–æ–±–∞–ª—å–Ω–∞—è –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è –≤—Ä–µ–º–µ–Ω–Ω–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
        let groupDragInfo = null;
        let tags = [];
        let manageTagsTempTags = null;
        let editModalInputText = ''; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–µ–∫—Å—Ç–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        let selectedFilterTags = []; // –ú–∞—Å—Å–∏–≤ –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö –º–µ—Ç–æ–∫ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        let autoSaveTimer = null;
        
        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const mapArea = document.getElementById('map-area');
        const mapContainer = document.querySelector('.map-container');
        const listContainer = document.getElementById('list-container');
        const addObjectBtn = document.getElementById('add-object');
        const toggleViewBtn = document.getElementById('toggle-view');
        const searchInput = document.getElementById('search');
        const filterTagsContainer = document.getElementById('filter-tags-container');
        const filterTagsTrigger = document.getElementById('filter-tags-trigger');
        const filterTagsDropdown = document.getElementById('filter-tags-dropdown');
        const filterTagsList = document.getElementById('filter-tags-list');
        const filterAllTags = document.getElementById('filter-all-tags');
        const filterDateFromInput = document.getElementById('filter-date-from');
        const filterDateToInput = document.getElementById('filter-date-to');
        const resetFiltersBtn = document.getElementById('reset-filters');
        const sortBySelect = document.getElementById('sort-by');
        const sortDirectionBtn = document.getElementById('sort-direction');
        const zoomInBtn = document.getElementById('zoom-in');
        const zoomOutBtn = document.getElementById('zoom-out');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        const editModal = document.getElementById('edit-modal');
        const modalClose = document.getElementById('modal-close');
        const modalSave = document.getElementById('modal-save');
        const moveToMapBtn = document.getElementById('move-to-map-btn');
        const editTitle = document.getElementById('edit-title');
        const editDateFrom = document.getElementById('edit-date-from');
        const editDateTo = document.getElementById('edit-date-to');
        const editColor = document.getElementById('edit-color');
        const editNote = document.getElementById('edit-note');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏
        const newTagModal = document.getElementById('new-tag-modal');
        const newTagClose = document.getElementById('new-tag-close');
        const newTagSave = document.getElementById('new-tag-save');
        const newTagName = document.getElementById('new-tag-name');
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∞–º–∏
        const manageTagsModal = document.getElementById('manage-tags-modal');
        const manageTagsClose = document.getElementById('manage-tags-close');
        const manageTagsList = document.getElementById('manage-tags-list');
        const manageTagsBtn = document.getElementById('manage-tags');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        function init() {
            // –ü—Ä–æ–±—É–µ–º –∑–∞–≥—Ä—É–∑–∏—Ç—å –ª–æ–∫–∞–ª—å–Ω—ã–π –∫—ç—à (–Ω–∞ —Å–ª—É—á–∞–π –æ—Ñ—Ñ–ª–∞–π–Ω–∞)
            loadFromLocalStorage();

            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            if (addObjectBtn) addObjectBtn.addEventListener('click', addNewObject);
            if (toggleViewBtn) toggleViewBtn.addEventListener('click', toggleView);
            // Debounce –¥–ª—è –ø–æ–∏—Å–∫–∞
            let searchDebounceTimeout = null;
            if (searchInput) searchInput.addEventListener('input', function() {
                if (searchDebounceTimeout) clearTimeout(searchDebounceTimeout);
                searchDebounceTimeout = setTimeout(filterObjects, 300);
            });
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–∫
            if (filterTagsTrigger) {
                filterTagsTrigger.addEventListener('click', toggleFilterTagsDropdown);
            }
            if (filterAllTags) {
                filterAllTags.addEventListener('change', handleFilterAllTags);
            }
            if (filterDateFromInput) filterDateFromInput.addEventListener('change', filterObjects);
            if (filterDateToInput) filterDateToInput.addEventListener('change', filterObjects);
            if (resetFiltersBtn) resetFiltersBtn.addEventListener('click', resetFilters);
            if (sortBySelect) sortBySelect.addEventListener('change', sortObjects);
            if (sortDirectionBtn) sortDirectionBtn.addEventListener('click', toggleSortDirection);
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–∞—Ä—Ç—ã
            if (mapContainer) mapContainer.addEventListener('mousedown', startPan);
            if (mapContainer) mapContainer.addEventListener('wheel', handleZoom, { passive: false });
            
            // –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É touch-—Å–æ–±—ã—Ç–∏–π –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
            if (mapContainer) {
                mapContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
                mapContainer.addEventListener('touchmove', handleTouchMove, { passive: false });
                mapContainer.addEventListener('touchend', handleTouchEnd, { passive: false });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            if (modalClose) modalClose.addEventListener('click', closeEditModal);
            if (modalSave) modalSave.addEventListener('click', () => {
                if (newObj) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ —Ñ–æ—Ä–º—ã
                    newObj.title = editTitle.value;
                    newObj.dateFrom = editDateFrom.value ? new Date(editDateFrom.value) : null;
                    newObj.dateTo = editDateTo.value ? new Date(editDateTo.value) : null;
                    newObj.color = editColor.value;
                    newObj.note = editNote.value;
                    newObj.tags = Array.from(document.querySelectorAll('#tags-container .tag-with-remove')).map(el => el.childNodes[0].textContent.trim());

                    // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—ã–π –æ–±—ä–µ–∫—Ç –≤ –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–∞–∫ "—Ç–æ–ª—å–∫–æ –≤ —Å–ø–∏—Å–∫–µ"
                    if (!objects.find(o => o.id === newObj.id)) {
                        objects.push(newObj);
                    }

                    currentEditId = newObj.id;
                    newObj = null; // –æ—á–∏—â–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç

                    syncGlobalTags();
                    closeEditModal();
                    renderObjects();
                    triggerAutoSave();
                } else if (currentEditId !== null) {
                    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ –æ–±—ä–µ–∫—Ç–∞
                    const obj = objects.find(o => o.id === currentEditId);
                    if (!obj) return;
                    obj.title = editTitle.value;
                    obj.dateFrom = editDateFrom.value ? new Date(editDateFrom.value) : null;
                    obj.dateTo = editDateTo.value ? new Date(editDateTo.value) : null;
                    obj.color = editColor.value;
                    obj.note = editNote.value;
                    // –°–æ—Ö—Ä–∞–Ω—è—é –º–µ—Ç–∫–∏ –∏–∑ DOM
                    obj.tags = Array.from(document.querySelectorAll('#tags-container .tag-with-remove')).map(el => el.childNodes[0].textContent.trim());
                    syncGlobalTags();
                    closeEditModal();
                    renderObjects();
                    triggerAutoSave();
                }
            });
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –Ω–∞ –∫–∞—Ä—Ç—É
            if (moveToMapBtn) {
                moveToMapBtn.addEventListener('click', () => {
                    if (currentEditId !== null) {
                        moveToListToMap(currentEditId);
                        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É –ø–æ—Å–ª–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                        moveToMapBtn.style.display = 'none';
                    }
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏
            if (newTagClose) newTagClose.addEventListener('click', closeNewTagModal);
            if (newTagSave) newTagSave.addEventListener('click', saveNewTag);
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–ó–∞–∫—Ä—ã—Ç—å"
            const newTagCloseBtn = document.getElementById('new-tag-close-btn');
            if (newTagCloseBtn) {
                newTagCloseBtn.addEventListener('click', closeNewTagModal);
            }
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Enter –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–æ–∫
            if (newTagName) {
                newTagName.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        saveNewTag();
                    }
                });
            }
            
            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∞–º–∏
            if (manageTagsClose) manageTagsClose.addEventListener('click', () => {
                manageTagsModal.style.display = 'none';
            });
            if (manageTagsBtn) manageTagsBtn.addEventListener('click', () => {
                renderManageTagsList();
                manageTagsModal.style.display = 'flex';
            });
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å (–µ—Å–ª–∏ —á—Ç–æ-—Ç–æ –∑–∞–≥—Ä—É–∑–∏–ª–æ—Å—å –∏–∑ localStorage)
            syncGlobalTags();
            renderObjects();
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ mapArea
            if (mapArea) mapArea.addEventListener('click', function(e) {
                if (creatingConnection) {
                    creatingConnection = false;
                    connectionStartId = null;
                    renderObjects();
                }
            });
            
            saveUndoState();
            
            // –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤:
            const addTagBtn = document.querySelector('.dropdown > button[type="button"]');
            if (addTagBtn) {
                addTagBtn.addEventListener('click', openNewTagModal);
            }

            // –í init() –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è manageTagsOpenBtn:
            const manageTagsOpenBtn = document.getElementById('manage-tags-open-btn');
            if (manageTagsOpenBtn) {
                manageTagsOpenBtn.onclick = () => {
                    console.log('–û—Ç–∫—Ä—ã–≤–∞—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∞–º–∏');
                    renderManageTagsList();
                    manageTagsModal.style.display = 'flex';
                };
                manageTagsOpenBtn.style.pointerEvents = 'auto';
            }

            // –í init() –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è DOM-—ç–ª–µ–º–µ–Ω—Ç–æ–≤:
            [editTitle, editDateFrom, editDateTo, editColor].forEach(input => {
                if (input) {
                    input.addEventListener('keydown', function(e) {
                        if (e.key === 'Enter' && e.target.tagName !== 'TEXTAREA') {
                            e.preventDefault();
                            if (modalSave) modalSave.click();
                        }
                    });
                }
            });

            // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫ –∑—É–º–∞
            if (zoomInBtn) zoomInBtn.addEventListener('click', () => handleZoomButton(0.1));
            if (zoomOutBtn) zoomOutBtn.addEventListener('click', () => handleZoomButton(-0.1));

            // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—é –∏, –ø–æ—Å–ª–µ –≤—Ö–æ–¥–∞, –∑–∞–≥—Ä—É–∑–∫—É –∏–∑ Supabase
            initAuth();
        }
        
        // –ü—Ä–æ—Å—Ç–æ–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ localStorage + Supabase
        function saveData() {
            const data = {
                objects: objects,
                connections: connections,
                version: 1
            };
            try {
                localStorage.setItem('mapListData', JSON.stringify(data));
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ localStorage:', e);
            }
            // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ Supabase (–µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞–ª–æ–≥–∏–Ω–µ–Ω)
            saveToSupabase();
        }

        // –î–µ–±–∞—É–Ω—Å-—Ç—Ä–∏–≥–≥–µ—Ä –¥–ª—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
        function triggerAutoSave() {
            if (autoSaveTimer) clearTimeout(autoSaveTimer);
            autoSaveTimer = setTimeout(saveData, 300);
        }

        // –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–∑ localStorage
        function loadFromLocalStorage() {
            const dataStr = localStorage.getItem('mapListData');
            if (!dataStr) return;
            try {
                const data = JSON.parse(dataStr);
                objects = data.objects || [];
                connections = data.connections || [];
                syncGlobalTags();
                updateConnectionsCount();
            } catch (err) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ localStorage', err);
            }
        }

           // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ —Å –ø–æ–¥—Å–æ–µ–¥–∏–Ω–µ–Ω–Ω—ã–º–∏ –æ–±—ä–µ–∫—Ç–∞–º–∏
        function startDrag(e) {
            console.log('startDrag', e);
            if (e.target.classList.contains('map-object-delete') || 
                e.target.classList.contains('map-object-connector') ||
                e.target.closest('.dropdown-content')) {
                return;
            }
            isDragging = true;
            selectedObject = objects.find(obj => obj.id == e.currentTarget.dataset.id);
            startX = e.clientX;
            startY = e.clientY;
            document.addEventListener('mousemove', handleDrag);
            document.addEventListener('mouseup', endDrag);
            e.preventDefault();
        }

        function handleDrag(e) {
            if (!isDragging || !selectedObject) return;
            const dx = (e.clientX - startX) / scale;
            const dy = (e.clientY - startY) / scale;
            selectedObject.x += dx;
            selectedObject.y += dy;
            startX = e.clientX;
            startY = e.clientY;
            renderObjects();
            updateConnectionLines(selectedObject.id);
        }
        
        function endDrag(e) {
            console.log('endDrag', e);
            isDragging = false;
            selectedObject = null;
            document.removeEventListener('mousemove', handleDrag);
            document.removeEventListener('mouseup', endDrag);
            triggerAutoSave();
        }
        
        // –ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
        function startPan(e) {
            if (e.target.closest('.map-object') || isDragging) return;
            isPanning = true;
            startX = e.clientX - offsetX;
            startY = e.clientY - offsetY;
            document.addEventListener('mousemove', handlePan);
            document.addEventListener('mouseup', endPan);
            e.preventDefault();
        }

        function handlePan(e) {
            if (isDragging) {
                handleDrag(e);
                return;
            }
            
            if (!isPanning) return;
            
            offsetX = e.clientX - startX;
            offsetY = e.clientY - startY;
            
            mapArea.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
        }

        function endPan() {
            isPanning = false;
            document.removeEventListener('mousemove', handlePan);
            document.removeEventListener('mouseup', endPan);
            if (isDragging) {
                endDrag();
            }
        }
        
        // –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
        function handleZoom(e) {
            e.preventDefault();
            const delta = e.deltaY > 0 ? -0.05 : 0.05;
            const newScale = Math.max(0.2, Math.min(3, scale + delta));
            if (newScale !== scale) {
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ —ç–∫—Ä–∞–Ω–∞
                const rect = mapContainer.getBoundingClientRect();
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const worldX = (centerX - offsetX) / scale;
                const worldY = (centerY - offsetY) / scale;
                scale = newScale;
                offsetX = centerX - worldX * scale;
                offsetY = centerY - worldY * scale;
                mapArea.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
        function addNewObject() {
            // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø–∏—Å–∫–∞ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
            newObj = {
                id: objects.length > 0 ? Math.max(...objects.map(o => o.id)) + 1 : 0,
                title: '–ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç',
                tags: [],
                dateFrom: null,
                dateTo: null,
                color: '#ffffff',
                connectionsCount: 0,
                x: null, // –ë–µ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç - –æ–±—ä–µ–∫—Ç –±—É–¥–µ—Ç —Ç–æ–ª—å–∫–æ –≤ —Å–ø–∏—Å–∫–µ
                y: null,
                width: 150,
                height: 60,
                note: '',
                collapsed: false,
                listOnly: true // –§–ª–∞–≥, —á—Ç–æ –æ–±—ä–µ–∫—Ç —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø–∏—Å–∫–∞
            };
            selectedObject = newObj; // –ù–æ–≤—ã–π –æ–±—ä–µ–∫—Ç —Å—Ä–∞–∑—É –≤—ã–±—Ä–∞–Ω
            // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
            currentEditId = newObj.id;
            editTitle.value = newObj.title;
            editDateFrom.value = '';
            editDateTo.value = '';
            editColor.value = newObj.color;
            editNote.value = newObj.note;
            // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
            editModalInputText = '';
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            editModal.style.display = 'flex';
            renderColorPicker(editColor.value);
            renderTagsInModal(newObj.tags);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–†–∞–∑–º–µ—Å—Ç–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç–µ" –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
            if (moveToMapBtn) {
                moveToMapBtn.style.display = 'inline-block';
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–≤—è–∑–∏ –º–µ–∂–¥—É –æ–±—ä–µ–∫—Ç–∞–º–∏
        function addConnection(fromId, toId) {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–π —Å–≤—è–∑–∏
            if (connections.some(conn => conn.from === fromId && conn.to === toId)) {
                return;
            }
            
            connections.push({ from: fromId, to: toId });
            
            // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–≤—è–∑–µ–π –¥–ª—è –æ–±–æ–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤
            updateConnectionsCount();
            
            renderObjects();
            triggerAutoSave();
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ —Å–≤—è–∑–µ–π –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        function updateConnectionsCount() {
            objects.forEach(obj => {
                obj.connectionsCount = 0;
            });
            
            connections.forEach(conn => {
                const fromObj = objects.find(o => o.id === conn.from);
                const toObj = objects.find(o => o.id === conn.to);
                
                if (fromObj) fromObj.connectionsCount++;
                if (toObj) toObj.connectionsCount++;
            });
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ –∫–∞—Ä—Ç—ã –∏ —Å–ø–∏—Å–∫–∞
        function toggleView() {
            isMapView = !isMapView;
            updateToggleViewIcon();
            if (isMapView) {
                mapContainer.style.display = 'block';
                listContainer.style.display = 'none';
                sortBySelect.style.display = 'none';
                sortDirectionBtn.style.display = 'none';
            } else {
                mapContainer.style.display = 'none';
                listContainer.style.display = 'block';
                sortBySelect.style.display = 'inline-block';
                sortDirectionBtn.style.display = 'inline-block';
                sortObjects();
            }
            renderObjects();
        }
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
        function toggleSortDirection() {
            sortDirection = -sortDirection;
            sortDirectionBtn.textContent = sortDirection > 0 ? '‚ñ≤' : '‚ñº';
            sortObjects();
        }
        
        // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
        function filterObjects() {
            renderObjects();
        }
        
        // –°–±—Ä–æ—Å —Ñ–∏–ª—å—Ç—Ä–æ–≤
        function resetFilters() {
            searchInput.value = '';
            selectedFilterTags = [];
            filterAllTags.checked = true;
            updateFilterTagsDisplay();
            filterDateFromInput.value = '';
            filterDateToInput.value = '';
            filterObjects();
        }
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ (–≤ —Ä–µ–∂–∏–º–µ —Å–ø–∏—Å–∫–∞)
        function sortObjects() {
            const sortBy = sortBySelect.value;
            objects.sort((a, b) => {
                if (sortBy === 'title') {
                    return a.title.localeCompare(b.title) * sortDirection;
                } else if (sortBy === 'date') {
                    if (!a.dateFrom && !b.dateFrom) return 0;
                    if (!a.dateFrom) return 1 * sortDirection;
                    if (!b.dateFrom) return -1 * sortDirection;
                    return (new Date(a.dateFrom) - new Date(b.dateFrom)) * sortDirection;
                } else if (sortBy === 'connections') {
                    return (b.connectionsCount - a.connectionsCount) * sortDirection;
                }
                return 0;
            });
            
            renderObjects();
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤
        function renderObjects() {
            const searchTerm = searchInput.value.toLowerCase();
            const selectedDateFrom = filterDateFromInput.value;
            const selectedDateTo = filterDateToInput.value;
            
            // –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –æ–±—ä–µ–∫—Ç–æ–≤
            const filteredObjects = objects.filter(obj => {
                // –ü–æ–∏—Å–∫ –ø–æ —Ç–µ–∫—Å—Ç—É
                if (searchTerm && !obj.title.toLowerCase().includes(searchTerm)) {
                    return false;
                }
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –º–µ—Ç–∫–∞–º
                if (selectedFilterTags.length > 0 && (!obj.tags || !obj.tags.some(tag => selectedFilterTags.includes(tag)))) {
                    return false;
                }
                
                // –§–∏–ª—å—Ç—Ä –ø–æ –¥–∞—Ç–µ
                if (selectedDateFrom) {
                    if (!obj.dateFrom || new Date(obj.dateFrom) < new Date(selectedDateFrom)) return false;
                }
                if (selectedDateTo) {
                    if (!obj.dateTo || new Date(obj.dateTo) > new Date(selectedDateTo)) return false;
                }
                
                return true;
            });
            
            if (isMapView) {
                renderMap(filteredObjects);
            } else {
                renderList(filteredObjects);
            }
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∫–∞—Ä—Ç—ã
        function renderMap(filteredObjects) {
            // –û—á–∏—â–∞–µ–º –∫–∞—Ä—Ç—É
            mapArea.innerHTML = '';
            
            // –°–Ω–∞—á–∞–ª–∞ —Ä–∏—Å—É–µ–º —Å–≤—è–∑–∏
            connections.forEach((conn, index) => {
                const fromObj = objects.find(o => o.id === conn.from);
                const toObj = objects.find(o => o.id === conn.to);
                
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Å–≤—è–∑–∏, –µ—Å–ª–∏ –æ–¥–∏–Ω –∏–∑ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –∏–ª–∏ –Ω–µ –≤–∏–¥–µ–Ω
                if (!fromObj || !toObj || 
                    !filteredObjects.includes(fromObj) || !filteredObjects.includes(toObj)) {
                    return;
                }
                
                const fromPoint = getBorderPoint(fromObj, toObj);
                const toPoint = getBorderPoint(toObj, fromObj);
                const fromX = fromPoint.x;
                const fromY = fromPoint.y;
                const toX = toPoint.x;
                const toY = toPoint.y;
                
                const line = document.createElement('div');
                line.className = 'connection';
                line.dataset.connectionId = index;
                

                
                // –õ–∏–Ω–∏—è —Å–æ —Å—Ç—Ä–µ–ª–∫–æ–π
                line.innerHTML = `
                    <svg width="${Math.abs(toX - fromX) + 40}" height="${Math.abs(toY - fromY) + 40}"
                         style="position:absolute; left:${Math.min(fromX, toX) - 20}px; top:${Math.min(fromY, toY) - 20}px; pointer-events: none;">
                        <defs>
                            <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="10" refY="3.5" orient="auto" markerUnits="strokeWidth">
                                <polygon points="0 0, 10 3.5, 0 7" fill="black" />
                            </marker>
                        </defs>
                        <line x1="${fromX - Math.min(fromX, toX) + 20}"
                              y1="${fromY - Math.min(fromY, toY) + 20}"
                              x2="${toX - Math.min(fromX, toX) + 20}"
                              y2="${toY - Math.min(fromY, toY) + 20}"
                              stroke="black" stroke-width="2" marker-end="url(#arrowhead)" />
                    </svg>`;
                
                const svg = line.querySelector('svg');
                if (svg) {
                    svg.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm('–£–¥–∞–ª–∏—Ç—å —Å–≤—è–∑—å?')) {
                            connections.splice(index, 1);
                            updateConnectionsCount();
                            renderObjects();
                            triggerAutoSave();
                        }
                    });
                }
                const svgLine = line.querySelector('line');
                if (svgLine) {
                    svgLine.style.pointerEvents = 'stroke';
                }
                
                mapArea.appendChild(line);
            });
            
            // –ó–∞—Ç–µ–º —Ä–∏—Å—É–µ–º –æ–±—ä–µ–∫—Ç—ã
            filteredObjects.forEach(obj => {
                // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –æ–±—ä–µ–∫—Ç—ã, –∫–æ—Ç–æ—Ä—ã–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø–∏—Å–∫–∞
                if (obj.listOnly) return;
                
                const objElement = document.createElement('div');
                objElement.className = 'map-object';
                objElement.style.left = `${obj.x}px`;
                objElement.style.top = `${obj.y}px`;
                objElement.style.width = `${obj.width}px`;
                objElement.style.height = `${obj.height}px`;
                objElement.style.backgroundColor = obj.color;

                objElement.dataset.id = obj.id;
                
                // –ê—Ç—Ä–∏–±—É—Ç—ã –æ–±—ä–µ–∫—Ç–∞ (–º–µ—Ç–∫–∏, –¥–∞—Ç–∞, –∑–∞–º–µ—Ç–∫–∞)
                let attributesHTML = '';
                if (obj.tags && obj.tags.length > 0) {
                    attributesHTML += `<div>${obj.tags.map(tag => `<span class='tag'>${tag}</span>`).join(' ')}</div>`;
                }
                if (obj.dateFrom || obj.dateTo) {
                    let dateStr = '';
                    let hasFutureDate = false;
                    let hasTodayDate = false;
                    
                    if (obj.dateFrom) {
                        const fromDate = new Date(obj.dateFrom);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        fromDate.setHours(0, 0, 0, 0);
                        
                        if (fromDate.getTime() === today.getTime()) {
                            hasTodayDate = true;
                        } else if (fromDate > today) {
                            hasFutureDate = true;
                        }
                        
                        dateStr += '–æ—Ç ' + new Date(obj.dateFrom).toLocaleDateString();
                    }
                    
                    if (obj.dateTo) {
                        const toDate = new Date(obj.dateTo);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        toDate.setHours(0, 0, 0, 0);
                        
                        if (toDate.getTime() === today.getTime()) {
                            hasTodayDate = true;
                        } else if (toDate > today) {
                            hasFutureDate = true;
                        }
                        
                        dateStr += (dateStr ? ' ' : '') + '–¥–æ ' + new Date(obj.dateTo).toLocaleDateString();
                    }
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
                    let dateStyle = '';
                    if (hasTodayDate) {
                        dateStyle = 'color: #008000; font-weight: bold;'; // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
                    } else {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ—à–µ–¥—à–∏–µ –¥–∞—Ç—ã
                        let hasPastDate = false;
                        if (obj.dateFrom) {
                            const fromDate = new Date(obj.dateFrom);
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            fromDate.setHours(0, 0, 0, 0);
                            if (fromDate < today) hasPastDate = true;
                        }
                        if (obj.dateTo) {
                            const toDate = new Date(obj.dateTo);
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            toDate.setHours(0, 0, 0, 0);
                            if (toDate < today) hasPastDate = true;
                        }
                        if (hasPastDate) {
                            dateStyle = 'color: #ff0000; font-weight: bold;'; // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö –¥–∞—Ç
                        }
                    }
                    
                    attributesHTML += `<div style="${dateStyle}">${dateStr}</div>`;
                }
                if (obj.connectionsCount > 0) {
                    attributesHTML += `<div>–°–≤—è–∑–∏: ${obj.connectionsCount}</div>`;
                }
                if (obj.note) {
                    attributesHTML += `<div class='map-object-attribute'>${obj.note.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>`;
                }
                
                objElement.innerHTML = `
                    <div class="map-object-header">
                        <div class="map-object-title">${obj.title}</div>
                        <div class="map-object-delete">√ó</div>
                    </div>
                    <div class="map-object-attributes">${attributesHTML}</div>
                    <div class="map-object-connector" title="–°–æ–∑–¥–∞—Ç—å —Å–≤—è–∑—å"></div>
                    <div class="dropdown">
                        <div class="dropdown-content">
                            <div class="dropdown-header">–î–µ–π—Å—Ç–≤–∏—è:</div>
                            <div class="dropdown-item" data-action="edit">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</div>
                        </div>
                    </div>
                `;
                
                // –í—ã–¥–µ–ª—è–µ–º —Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—å, –µ—Å–ª–∏ –æ–Ω –∞–∫—Ç–∏–≤–µ–Ω
                if (creatingConnection && connectionStartId === obj.id) {
                    objElement.querySelector('.map-object-connector').classList.add('active');
                }
                
                // –ï—Å–ª–∏ —ç—Ç–æ—Ç –æ–±—ä–µ–∫—Ç ‚Äî –ø–æ—Ç–æ–º–æ–∫ —Å–≤–µ—Ä–Ω—É—Ç–æ–≥–æ, –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –µ–≥–æ
                let parent = connections.find(conn => conn.to === obj.id);
                let skip = false;
                while (parent) {
                    const parentObj = objects.find(o => o.id === parent.from);
                    if (parentObj && parentObj.collapsed) {
                        skip = true;
                        break;
                    }
                    parent = connections.find(conn => conn.to === parent.from);
                }
                if (skip) return;
                
                mapArea.appendChild(objElement);
                
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–≤—è–∑–∏
                const connector = objElement.querySelector('.map-object-connector');
                connector.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (!creatingConnection) {
                        creatingConnection = true;
                        connectionStartId = obj.id;
                        connector.classList.add('active');
                    } else if (connectionStartId !== obj.id) {
                        addConnection(connectionStartId, obj.id);
                        creatingConnection = false;
                        connectionStartId = null;
                        renderObjects();
                    }
                });
                
                objElement.addEventListener('mousedown', function(e) {
                    startGroupDrag(e, obj.id);
                });
                
                const deleteBtn = objElement.querySelector('.map-object-delete');
                if (deleteBtn) {
                    deleteBtn.className = 'map-object-delete';
                    deleteBtn.style.color = '#c00';
                    deleteBtn.style.cursor = 'pointer';
                    deleteBtn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        if (confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç?')) {
                            deleteObject(obj.id);
                        }
                    });
                }
                
                const dropdownItems = objElement.querySelectorAll('.dropdown-item');
                dropdownItems.forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const action = item.dataset.action;
                        if (action === 'edit') {
                            openEditModal(obj.id);
                        }
                    });
                });
                
                const titleEl = objElement.querySelector('.map-object-title');
                if (titleEl) {
                    titleEl.addEventListener('click', () => {
                        console.log('click title', obj.id);
                        openEditModal(obj.id);
                    });
                }
                
                // –ö–ª–∏–∫ –ø–æ –≤—Å–µ–º—É –æ–±—ä–µ–∫—Ç—É (–∫—Ä–æ–º–µ —É–¥–∞–ª–µ–Ω–∏—è –∏ —Å–æ–µ–¥–∏–Ω–∏—Ç–µ–ª—è)
                objElement.addEventListener('click', function(e) {
                    if (
                        e.target.classList.contains('map-object-delete') ||
                        e.target.classList.contains('map-object-connector') ||
                        e.target.closest('.dropdown-content')
                    ) {
                        return;
                    }
                    openEditModal(obj.id);
                });
            });
            
            // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—é –º–∞—Å—à—Ç–∞–±–∞ –∏ —Å–º–µ—â–µ–Ω–∏—è
            mapArea.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
            
            // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –æ–±—ä–µ–∫—Ç–∞ –ø–æ–¥ —Ç–µ–∫—Å—Ç
            if (isMapView) {
                adjustObjectSizes();
            }
        }
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–ø–∏—Å–∫–∞
        function renderList(filteredObjects) {
            listContainer.innerHTML = '';
            // –°–æ–∑–¥–∞—ë–º —Ç–∞–±–ª–∏—Ü—É
            const table = document.createElement('table');
            table.style.width = '100%';
            table.style.borderCollapse = 'collapse';
            table.innerHTML = `
                <tbody></tbody>
            `;
            const tbody = table.querySelector('tbody');
            filteredObjects.forEach(obj => {
                const tr = document.createElement('tr');
                tr.style.backgroundColor = obj.color;

                // –ö—Ä–µ—Å—Ç–∏–∫ —É–¥–∞–ª–µ–Ω–∏—è
                const tdDel = document.createElement('td');
                tdDel.style.border = '1px solid #ddd';
                tdDel.style.padding = '6'; // –£–±–∏—Ä–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã
                tdDel.style.width = '50px'; // –ó–∞–¥–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—É—é —à–∏—Ä–∏–Ω—É
                tdDel.style.textAlign = 'center';
                const delBtn = document.createElement('span');
                delBtn.textContent = '√ó';
                delBtn.className = 'app-btn icon';
                delBtn.style.color = '#c00';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm('–£–¥–∞–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç?')) {
                        deleteObject(obj.id);
                    }
                };
                tdDel.appendChild(delBtn);
                tr.appendChild(tdDel);
                // –ù–∞–∑–≤–∞–Ω–∏–µ
                const tdTitle = document.createElement('td');
                tdTitle.style.border = '1px solid #ddd';
                tdTitle.style.padding = '6px';
                tdTitle.textContent = obj.title;
                tdTitle.style.fontWeight = 'bold';
                tdTitle.style.cursor = 'pointer';
                tdTitle.ondblclick = () => openEditModal(obj.id);
                tr.appendChild(tdTitle);
                // –ú–µ—Ç–∫–∏
                const tdTags = document.createElement('td');
                tdTags.style.border = '1px solid #ddd';
                tdTags.style.padding = '6px';
                if (obj.tags && obj.tags.length > 0) {
                    tdTags.innerHTML = obj.tags.map(tag => `<span class='tag'>${tag}</span>`).join(' ');
                } else {
                    tdTags.innerHTML = '';
                }
                tr.appendChild(tdTags);
                // –î–∞—Ç–∞
                const tdDate = document.createElement('td');
                tdDate.style.border = '1px solid #ddd';
                tdDate.style.padding = '6px';
                if (obj.dateFrom || obj.dateTo) {
                    let dateStr = '';
                    let hasFutureDate = false;
                    let hasTodayDate = false;
                    
                    if (obj.dateFrom) {
                        const fromDate = new Date(obj.dateFrom);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        fromDate.setHours(0, 0, 0, 0);
                        
                        if (fromDate.getTime() === today.getTime()) {
                            hasTodayDate = true;
                        } else if (fromDate > today) {
                            hasFutureDate = true;
                        }
                        
                        dateStr += '–æ—Ç ' + new Date(obj.dateFrom).toLocaleDateString();
                    }
                    
                    if (obj.dateTo) {
                        const toDate = new Date(obj.dateTo);
                        const today = new Date();
                        today.setHours(0, 0, 0, 0);
                        toDate.setHours(0, 0, 0, 0);
                        
                        if (toDate.getTime() === today.getTime()) {
                            hasTodayDate = true;
                        } else if (toDate > today) {
                            hasFutureDate = true;
                        }
                        
                        dateStr += (dateStr ? ' ' : '') + '–¥–æ ' + new Date(obj.dateTo).toLocaleDateString();
                    }
                    
                    // –ü—Ä–∏–º–µ–Ω—è–µ–º —Ü–≤–µ—Ç–æ–≤–æ–µ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏–µ
                    if (hasTodayDate) {
                        tdDate.style.color = '#008000'; // –ó–µ–ª–µ–Ω—ã–π –¥–ª—è —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–π –¥–∞—Ç—ã
                        tdDate.style.fontWeight = 'bold';
                    } else {
                        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –ø—Ä–æ—à–µ–¥—à–∏–µ –¥–∞—Ç—ã
                        let hasPastDate = false;
                        if (obj.dateFrom) {
                            const fromDate = new Date(obj.dateFrom);
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            fromDate.setHours(0, 0, 0, 0);
                            if (fromDate < today) hasPastDate = true;
                        }
                        if (obj.dateTo) {
                            const toDate = new Date(obj.dateTo);
                            const today = new Date();
                            today.setHours(0, 0, 0, 0);
                            toDate.setHours(0, 0, 0, 0);
                            if (toDate < today) hasPastDate = true;
                        }
                        if (hasPastDate) {
                            tdDate.style.color = '#ff0000'; // –ö—Ä–∞—Å–Ω—ã–π –¥–ª—è –ø—Ä–æ—à–µ–¥—à–∏—Ö –¥–∞—Ç
                            tdDate.style.fontWeight = 'bold';
                        }
                    }
                    
                    tdDate.innerHTML = dateStr;
                } else {
                    tdDate.innerHTML = '';
                }
                tr.appendChild(tdDate);
                // –°–≤—è–∑–∏
                const tdConn = document.createElement('td');
                tdConn.style.border = '1px solid #ddd';
                tdConn.style.padding = '6px';
                tdConn.textContent = obj.connectionsCount > 0 ? obj.connectionsCount : '';
                tr.appendChild(tdConn);
                // –ó–∞–º–µ—Ç–∫–∞
                const tdNote = document.createElement('td');
                tdNote.style.border = '1px solid #ddd';
                tdNote.style.padding = '6px';
                tdNote.innerHTML = obj.note ? obj.note.replace(/</g, '&lt;').replace(/>/g, '&gt;') : '';
                tr.appendChild(tdNote);
                tbody.appendChild(tr);
            });
            listContainer.appendChild(table);
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
        function deleteObject(id) {
            // –£–¥–∞–ª—è–µ–º —Å–≤—è–∑–∏, —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Å —ç—Ç–∏–º –æ–±—ä–µ–∫—Ç–æ–º
            connections = connections.filter(conn => conn.from !== id && conn.to !== id);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ —Å–≤—è–∑–µ–π
            updateConnectionsCount();
            
            // –£–¥–∞–ª—è–µ–º —Å–∞–º –æ–±—ä–µ–∫—Ç
            objects = objects.filter(obj => obj.id !== id);
            
            syncGlobalTags();
            renderObjects();
            triggerAutoSave();
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function openEditModal(id) {
            console.log('–û—Ç–∫—Ä—ã–≤–∞—é –º–æ–¥–∞–ª–∫—É', id);
            const obj = objects.find(o => o.id === id) || newObj;
            if (!obj) {
                console.log('–û–±—ä–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', id, objects);
                return;
            }
            currentEditId = id;
            editTitle.value = obj.title;
            editDateFrom.value = obj.dateFrom ? new Date(obj.dateFrom).toISOString().split('T')[0] : '';
            editDateTo.value = obj.dateTo ? new Date(obj.dateTo).toISOString().split('T')[0] : '';
            editColor.value = obj.color;
            editNote.value = obj.note || '';
            // –ù–µ –æ—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –Ω–æ–≤–æ–≥–æ –æ–±—ä–µ–∫—Ç–∞
            renderTagsInModal(obj.tags);
            editModal.style.display = 'flex';
            renderColorPicker(editColor.value);
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–Ω–æ–ø–∫—É "–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –Ω–∞ –∫–∞—Ä—Ç—É" —Ç–æ–ª—å–∫–æ –¥–ª—è –æ–±—ä–µ–∫—Ç–æ–≤ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø–∏—Å–∫–∞
            if (moveToMapBtn) {
                if (obj.listOnly) {
                    moveToMapBtn.style.display = 'inline-block';
                } else {
                    moveToMapBtn.style.display = 'none';
                }
            }
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
        function closeEditModal() {
            editModal.style.display = 'none';
            currentEditId = null;
            if (newObj) newObj = null;
            // –û—á–∏—â–∞–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            editModalInputText = '';
        }
        
        // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏
        function openNewTagModal() {
            newTagName.value = '';
            newTagModal.style.display = 'flex';
            // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞
            newTagName.focus();
        }
        
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏
        function closeNewTagModal() {
            newTagModal.style.display = 'none';
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏
        function saveNewTag() {
            const newTag = newTagName.value.trim();
            if (!newTag || tags.includes(newTag)) return;
            tags.push(newTag);
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–π –º–µ—Ç–∫–∏
            newTagName.value = '';
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –æ–±—ä–µ–∫—Ç ‚Äî –¥–æ–±–∞–≤–∏–º –º–µ—Ç–∫—É –∫ –Ω–µ–º—É —Å—Ä–∞–∑—É
            const obj = objects.find(o => o.id === currentEditId) || newObj;
            if (obj && !obj.tags.includes(newTag)) {
                obj.tags.push(newTag);
            }
            syncGlobalTags();
            renderTagsInModal(obj ? obj.tags : []);
            renderManageTagsList();
            renderObjects();
            // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π –º–µ—Ç–∫–∏
            newTagName.focus();
            triggerAutoSave();
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑–º–µ—Ä–æ–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –ø–æ–¥ —Ç–µ–∫—Å—Ç
        function adjustObjectSizes() {
            const objectElements = document.querySelectorAll('.map-object');
            
            objectElements.forEach(objElement => {
                const id = parseInt(objElement.dataset.id);
                const obj = objects.find(o => o.id === id);
                if (!obj) return;
                
                // –ò–∑–º–µ—Ä—è–µ–º —à–∏—Ä–∏–Ω—É —Ç–µ–∫—Å—Ç–∞
                const titleElement = objElement.querySelector('.map-object-title');
                const tempSpan = document.createElement('span');
                tempSpan.style.visibility = 'hidden';
                tempSpan.style.whiteSpace = 'nowrap';
                tempSpan.style.position = 'absolute';
                tempSpan.style.fontSize = window.getComputedStyle(titleElement).fontSize;
                tempSpan.style.fontFamily = window.getComputedStyle(titleElement).fontFamily;
                tempSpan.style.fontWeight = window.getComputedStyle(titleElement).fontWeight;
                tempSpan.textContent = obj.title;
                
                document.body.appendChild(tempSpan);
                const textWidth = tempSpan.offsetWidth + 30; // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç—Å—Ç—É–ø—ã
                document.body.removeChild(tempSpan);
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω–æ–≤—É—é —à–∏—Ä–∏–Ω—É
                const newWidth = Math.max(60, textWidth);
                obj.width = newWidth;
                objElement.style.width = `${newWidth}px`;
                
                // –ü–æ–¥—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤—ã—Å–æ—Ç—É –ø–æ–¥ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
                const contentHeight = objElement.scrollHeight;
                const newHeight = Math.max(60, contentHeight);
                obj.height = newHeight;
                objElement.style.height = `${newHeight}px`;
            });
        }
        
        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è –ø–µ—Ä–µ–¥ –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º
        function saveUndoState() {
            undoState = {
                objects: JSON.parse(JSON.stringify(objects)),
                scale,
                offsetX,
                offsetY
            };
        }
        
        // –§—É–Ω–∫—Ü–∏—è –æ—Ç–º–µ–Ω—ã
        function undo() {
            if (!undoState) return;
            objects = JSON.parse(JSON.stringify(undoState.objects));
            scale = undoState.scale;
            offsetX = undoState.offsetX;
            offsetY = undoState.offsetY;
            updateConnectionsCount();
            renderObjects();
            undoState = null;
        }
        
        // –î–æ–±–∞–≤–ª—è—é –∑–∞–≥–ª—É—à–∫—É –¥–ª—è findConnectedObjects
        function findConnectedObjects(parentId, resultSet) {
            // –ü–æ–∫–∞ –Ω–∏—á–µ–≥–æ –Ω–µ –¥–µ–ª–∞–µ–º, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ –æ—à–∏–±–∫–∏
        }
        
        // –î–æ–±–∞–≤–ª—è—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–µ–ª–æ–∫
        function updateConnectionLines(movedId) {
            connections.forEach((conn, index) => {
                if (conn.from === movedId || conn.to === movedId) {
                    const fromObj = objects.find(o => o.id === conn.from);
                    const toObj = objects.find(o => o.id === conn.to);
                    if (!fromObj || !toObj) return;
                    const fromPoint = getBorderPoint(fromObj, toObj);
                    const toPoint = getBorderPoint(toObj, fromObj);
                    const fromX = fromPoint.x;
                    const fromY = fromPoint.y;
                    const toX = toPoint.x;
                    const toY = toPoint.y;
                    const lineDiv = document.querySelector(`.connection[data-connection-id='${index}']`);
                    if (lineDiv) {
                        const svg = lineDiv.querySelector('svg');
                        const line = svg ? svg.querySelector('line') : null;
                        if (line) {
                            // svg –º–æ–∂–µ—Ç –±—ã—Ç—å —Å–¥–≤–∏–Ω—É—Ç, –∫–∞–∫ –∏ –≤ renderMap
                            const left = Math.min(fromX, toX) - 20;
                            const top = Math.min(fromY, toY) - 20;
                            svg.setAttribute('width', Math.abs(toX - fromX) + 40);
                            svg.setAttribute('height', Math.abs(toY - fromY) + 40);
                            svg.style.left = `${left}px`;
                            svg.style.top = `${top}px`;
                            line.setAttribute('x1', fromX - Math.min(fromX, toX) + 20);
                            line.setAttribute('y1', fromY - Math.min(fromY, toY) + 20);
                            line.setAttribute('x2', toX - Math.min(fromX, toX) + 20);
                            line.setAttribute('y2', toY - Math.min(fromY, toY) + 20);
                        }
                    }
                }
            });
        }
        
        // –î–æ–±–∞–≤–ª—è—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –≤—ã—á–∏—Å–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏ –Ω–∞ –≥—Ä–∞–Ω–∏—Ü–µ –æ–±—ä–µ–∫—Ç–∞, –±–ª–∏–∂–∞–π—à–µ–π –∫ –¥—Ä—É–≥–æ–º—É –æ–±—ä–µ–∫—Ç—É
        function getBorderPoint(obj, targetObj) {
            const cx = obj.x + obj.width / 2;
            const cy = obj.y + obj.height / 2;
            const tx = targetObj.x + targetObj.width / 2;
            const ty = targetObj.y + targetObj.height / 2;
            const dx = tx - cx;
            const dy = ty - cy;
            const absDx = Math.abs(dx);
            const absDy = Math.abs(dy);
            let x, y;
            if (absDx / obj.width > absDy / obj.height) {
                // –ë–ª–∏–∂–µ –∫ –±–æ–∫–æ–≤–æ–π –≥—Ä–∞–Ω–∏
                if (dx > 0) {
                    x = obj.x + obj.width;
                    y = cy;
                } else {
                    x = obj.x;
                    y = cy;
                }
            } else {
                // –ë–ª–∏–∂–µ –∫ –≤–µ—Ä—Ö–Ω–µ–π/–Ω–∏–∂–Ω–µ–π –≥—Ä–∞–Ω–∏
                if (dy > 0) {
                    x = cx;
                    y = obj.y + obj.height;
                } else {
                    x = cx;
                    y = obj.y;
                }
            }
            return { x, y };
        }
        
        // –í JS, –ø–æ—Å–ª–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è editColor:
        const colorPicker = document.getElementById('color-picker');
        const pastelColors = [
            { hex: '#FFB3BA', name: '–ü–∞—Å—Ç–µ–ª—å–Ω—ã–π –∫—Ä–∞—Å–Ω—ã–π' },
            { hex: '#FFD8B1', name: '–ü–∞—Å—Ç–µ–ª—å–Ω—ã–π –æ—Ä–∞–Ω–∂–µ–≤—ã–π' },
            { hex: '#FFFFBA', name: '–ü–∞—Å—Ç–µ–ª—å–Ω—ã–π –∂—ë–ª—Ç—ã–π' },
            { hex: '#BAFFC9', name: '–ü–∞—Å—Ç–µ–ª—å–Ω—ã–π –∑–µ–ª—ë–Ω—ã–π' },
            { hex: '#BAE1FF', name: '–ü–∞—Å—Ç–µ–ª—å–Ω—ã–π –≥–æ–ª—É–±–æ–π' },
            { hex: '#B3C6FF', name: '–ü–∞—Å—Ç–µ–ª—å–Ω—ã–π —Å–∏–Ω–∏–π' },
            { hex: '#E2BAFF', name: '–ü–∞—Å—Ç–µ–ª—å–Ω—ã–π —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π' },
            { hex: '#FFFFFF', name: '–ë–µ–ª—ã–π' }
        ];
        function renderColorPicker(selectedHex) {
            colorPicker.innerHTML = '';
            pastelColors.forEach(color => {
                const swatch = document.createElement('div');
                swatch.title = color.name;
                swatch.style.width = '32px';
                swatch.style.height = '32px';
                swatch.style.borderRadius = '6px';
                swatch.style.border = color.hex === selectedHex ? '3px solid #333' : '2px solid #ccc';
                swatch.style.boxShadow = '0 1px 4px rgba(0,0,0,0.08)';
                swatch.style.background = color.hex;
                swatch.style.cursor = 'pointer';
                swatch.addEventListener('click', () => {
                    document.getElementById('edit-color').value = color.hex;
                    renderColorPicker(color.hex);
                });
                colorPicker.appendChild(swatch);
            });
        }
        
        function renderManageTagsList() {
            manageTagsList.innerHTML = '';
            const obj = objects.find(o => o.id === currentEditId) || newObj;
            // –ö–æ–ø–∏—Ä—É–µ–º —Ç–µ–∫—É—â–∏–µ –º–µ—Ç–∫–∏ –æ–±—ä–µ–∫—Ç–∞ –≤–æ –≤—Ä–µ–º–µ–Ω–Ω—ã–π –º–∞—Å—Å–∏–≤
            if (obj) {
                manageTagsTempTags = Array.isArray(obj.tags) ? [...obj.tags] : [];
            } else {
                manageTagsTempTags = [];
            }
            // –°–Ω–∞—á–∞–ª–∞ —Å—Ç—Ä–æ–∫–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–π –º–µ—Ç–∫–∏ (–≤–µ—Ä—Ö–Ω—è—è)
            const newTagRow = document.createElement('div');
            newTagRow.style.display = 'flex';
            newTagRow.style.alignItems = 'center';
            newTagRow.style.marginBottom = '10px';
            const newInput = document.createElement('input');
            newInput.type = 'text';
            newInput.id = 'manage-tags-new-input';
            newInput.placeholder = '–ù–æ–≤–∞—è –º–µ—Ç–∫–∞';
            newInput.style.flex = '1';
            newInput.style.marginRight = '8px';
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ–ª—è –≤–≤–æ–¥–∞
            let previousValue = '';
            const oldInput = document.getElementById('manage-tags-new-input');
            if (oldInput && oldInput.value.trim()) {
                previousValue = oldInput.value;
            }
            newInput.value = previousValue;
            const addBtn = document.createElement('button');
            addBtn.id = 'manage-tags-add';
            addBtn.textContent = '–î–æ–±–∞–≤–∏—Ç—å';
            addBtn.onclick = () => {
                const newTag = newInput.value.trim();
                if (!newTag || tags.includes(newTag)) return;
                tags.push(newTag);
                // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≤–≤–æ–¥–∞ –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
                newInput.value = '';
                // –§–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –æ–±—Ä–∞—Ç–Ω–æ –Ω–∞ –ø–æ–ª–µ –≤–≤–æ–¥–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–π –º–µ—Ç–∫–∏
                newInput.focus();
                renderManageTagsList();
                syncGlobalTags();
                renderTagsInModal(objects.find(o => o.id === currentEditId)?.tags || []);
                renderObjects();
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∞–≤–∏—à–∏ Enter –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è
            newInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    addBtn.click();
                }
            });
            newTagRow.appendChild(newInput);
            newTagRow.appendChild(addBtn);
            manageTagsList.appendChild(newTagRow);
            // –ó–∞—Ç–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–∫–∏
            tags.forEach((tag, idx) => {
                const row = document.createElement('div');
                row.style.display = 'flex';
                row.style.alignItems = 'center';
                row.style.marginBottom = '6px';
                // –ß–µ–∫–±–æ–∫—Å –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—É–¥–∞–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏ —É –æ–±—ä–µ–∫—Ç–∞
                const tagCheckbox = document.createElement('input');
                tagCheckbox.type = 'checkbox';
                tagCheckbox.style.marginRight = '8px';
                tagCheckbox.style.width = '18px';
                tagCheckbox.style.height = '18px';
                tagCheckbox.style.verticalAlign = 'middle';
                tagCheckbox.checked = manageTagsTempTags.includes(tag);
                tagCheckbox.onchange = () => {
                    if (tagCheckbox.checked) {
                        if (!manageTagsTempTags.includes(tag)) manageTagsTempTags.push(tag);
                    } else {
                        manageTagsTempTags = manageTagsTempTags.filter(t => t !== tag);
                    }
                };
                row.appendChild(tagCheckbox);
                // –ú–µ—Ç–∫–∞
                const tagSpan = document.createElement('span');
                tagSpan.textContent = tag;
                tagSpan.style.flex = '1';
                tagSpan.style.background = '#e0e0e0';
                tagSpan.style.borderRadius = '3px';
                tagSpan.style.padding = '2px 8px';
                tagSpan.style.marginRight = '8px';
                // –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è
                const removeBtn = document.createElement('span');
                removeBtn.textContent = '√ó';
                removeBtn.title = '–£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É –∏–∑ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤';
                removeBtn.style.cursor = 'pointer';
                removeBtn.style.color = '#c00';
                removeBtn.style.fontSize = '1.2em';
                removeBtn.onclick = () => {
                    if (confirm('–£–¥–∞–ª–∏—Ç—å –º–µ—Ç–∫—É "' + tag + '" –∏–∑ –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤?')) {
                        tags = tags.filter(t => t !== tag);
                        objects.forEach(obj => {
                            if (obj.tags) obj.tags = obj.tags.filter(t => t !== tag);
                        });
                        syncGlobalTags();
                        renderManageTagsList();
                        renderTagsInModal(objects.find(o => o.id === currentEditId)?.tags || []);
                        renderObjects();
                    }
                };
                row.appendChild(tagSpan);
                row.appendChild(removeBtn);
                manageTagsList.appendChild(row);
            });
        }
        
        // –î–æ–±–∞–≤–ª—è—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –ø–æ–∏—Å–∫–∞ –≤—Å–µ—Ö –ø–æ—Ç–æ–º–∫–æ–≤
        function getAllChildrenIds(parentId, result = []) {
            connections.forEach(conn => {
                if (conn.from === parentId) {
                    result.push(conn.to);
                    getAllChildrenIds(conn.to, result);
                }
            });
            return result;
        }
        
        function startGroupDrag(e, parentId) {
            if (e.target.classList.contains('map-object-delete') || 
                e.target.classList.contains('map-object-connector') ||
                e.target.closest('.dropdown-content')) {
                return;
            }
            isDragging = true;
            selectedObject = objects.find(obj => obj.id == parentId);
            const childIds = getAllChildrenIds(parentId);
            groupDragInfo = {
                startX: e.clientX,
                startY: e.clientY,
                objects: [selectedObject, ...objects.filter(o => childIds.includes(o.id))],
                positions: []
            };
            groupDragInfo.objects.forEach(obj => {
                groupDragInfo.positions.push({ x: obj.x, y: obj.y });
            });
            document.addEventListener('mousemove', handleGroupDrag);
            document.addEventListener('mouseup', endGroupDrag);
            e.preventDefault();
        }
        function handleGroupDrag(e) {
            if (!isDragging || !groupDragInfo) return;
            const dx = (e.clientX - groupDragInfo.startX) / scale;
            const dy = (e.clientY - groupDragInfo.startY) / scale;
            groupDragInfo.objects.forEach((obj, i) => {
                obj.x = groupDragInfo.positions[i].x + dx;
                obj.y = groupDragInfo.positions[i].y + dy;
            });
            renderObjects();
            groupDragInfo.objects.forEach(obj => updateConnectionLines(obj.id));
        }
        function endGroupDrag(e) {
            isDragging = false;
            selectedObject = null;
            groupDragInfo = null;
            document.removeEventListener('mousemove', handleGroupDrag);
            document.removeEventListener('mouseup', endGroupDrag);
            triggerAutoSave();
        }
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', init);

        // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –º–µ—Ç–æ–∫ ---
        // window.addEventListener('click', function(e) {
        //     const menuContent = document.getElementById('tags-menu-content');
        //     if (menuContent && !e.target.matches('.tags-dropdown-trigger')) {
        //         if (menuContent.classList.contains('show')) {
        //             menuContent.classList.remove('show');
        //         }
        //     }
        // });

        function renderTagsInModal(tagsList) {
            const tagsContainer = document.getElementById('tags-container');
            if (!tagsContainer) return;
            tagsContainer.innerHTML = '';
            tagsList.forEach(tag => {
                addTagToTagsContainer(tag, tagsContainer);
            });
        }

        // –î–æ–±–∞–≤–∏—Ç—å –º–µ—Ç–∫—É –≤ DOM –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä (–±–µ–∑ —Ä–µ—Ä–µ–Ω–¥–µ—Ä–∞ –≤—Å–µ–≥–æ –æ–∫–Ω–∞)
        function addTagToTagsContainer(tag, container) {
            const tagElement = document.createElement('div');
            tagElement.className = 'tag-with-remove';
            tagElement.innerHTML = `${tag} <span class="tag-remove" data-tag="${tag}">√ó</span>`;
            container.appendChild(tagElement);
            tagElement.querySelector('.tag-remove').addEventListener('click', (e) => {
                const tagToRemove = e.target.dataset.tag;
                const obj = objects.find(o => o.id === currentEditId) || newObj;
                if (obj) {
                    obj.tags = obj.tags.filter(t => t !== tagToRemove);
                    syncGlobalTags();
                    // –£–¥–∞–ª—è–µ–º —Ç–æ–ª—å–∫–æ DOM-—ç–ª–µ–º–µ–Ω—Ç –º–µ—Ç–∫–∏, –Ω–µ —Ä–µ–Ω–¥–µ—Ä–∏–º –≤—Å—ë –æ–∫–Ω–æ
                    tagElement.remove();
                }
            });
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –º–µ—Ç–∫–∏ –∏–∑ –ø–æ–ª—è –≤–≤–æ–¥–∞ (–≤—ã–∑—ã–≤–∞—Ç—å –∏–∑ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∞ –∫–Ω–æ–ø–∫–∏/Enter)
        function addTagToCurrentObject(newTag) {
            const obj = objects.find(o => o.id === currentEditId) || newObj;
            if (!obj || !newTag || obj.tags.includes(newTag)) return;
            obj.tags.push(newTag);
            syncGlobalTags();
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ DOM-—ç–ª–µ–º–µ–Ω—Ç –º–µ—Ç–∫–∏
            const tagsContainer = document.getElementById('tags-container');
            if (tagsContainer) addTagToTagsContainer(newTag, tagsContainer);
        }

        // –í JS –ø–æ—Å–ª–µ manageTagsBtn:
        const manageTagsOpenBtn = document.getElementById('manage-tags-open-btn');
        if (manageTagsOpenBtn) {
            manageTagsOpenBtn.onclick = () => {
                console.log('–û—Ç–∫—Ä—ã–≤–∞—é —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –º–µ—Ç–∫–∞–º–∏');
                renderManageTagsList();
                manageTagsModal.style.display = 'flex';
            };
        }

        // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å' –≤ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–∏ –º–µ—Ç–∫–∞–º–∏
        const manageTagsSave = document.getElementById('manage-tags-save');
        if (manageTagsSave) {
            manageTagsSave.onclick = () => {
                const obj = objects.find(o => o.id === currentEditId) || newObj;
                if (obj) {
                    obj.tags = [...manageTagsTempTags];
                    syncGlobalTags();
                    renderTagsInModal(obj.tags);
                    renderObjects();
                    triggerAutoSave();
                }
                manageTagsModal.style.display = 'none';
                // –ï—Å–ª–∏ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –æ—Ç–∫—Ä—ã—Ç–æ, –æ–±–Ω–æ–≤–∏—Ç—å –ø–æ–ª—è
                if (editModal && editModal.style.display === 'flex') {
                    editTitle.value = obj.title;
                    editDateFrom.value = obj.dateFrom ? new Date(obj.dateFrom).toISOString().split('T')[0] : '';
                    editDateTo.value = obj.dateTo ? new Date(obj.dateTo).toISOString().split('T')[0] : '';
                    editColor.value = obj.color;
                    editNote.value = obj.note || '';
                }
            };
        }

        // –î–æ–±–∞–≤–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏—é:
        function syncGlobalTags() {
            const allTags = new Set();
            objects.forEach(obj => {
                (obj.tags || []).forEach(tag => allTags.add(tag));
            });
            tags = Array.from(allTags);
            updateFilterTagsDisplay();
        }
        

        
        // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ –º–µ—Ç–æ–∫ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        function toggleFilterTagsDropdown() {
            if (filterTagsDropdown.style.display === 'none') {
                filterTagsDropdown.style.display = 'block';
                renderFilterTagsList();
            } else {
                filterTagsDropdown.style.display = 'none';
            }
        }
        
        function renderFilterTagsList() {
            if (!filterTagsList) return;
            
            filterTagsList.innerHTML = '';
            tags.forEach(tag => {
                const label = document.createElement('label');
                label.style.display = 'flex';
                label.style.alignItems = 'center';
                label.style.padding = '5px';
                label.style.cursor = 'pointer';
                label.style.borderBottom = '1px solid #eee';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.style.marginRight = '5px';
                checkbox.checked = selectedFilterTags.includes(tag);
                checkbox.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        if (!selectedFilterTags.includes(tag)) {
                            selectedFilterTags.push(tag);
                        }
                    } else {
                        selectedFilterTags = selectedFilterTags.filter(t => t !== tag);
                    }
                    updateFilterTagsDisplay();
                    filterObjects();
                });
                
                const span = document.createElement('span');
                span.textContent = tag;
                
                label.appendChild(checkbox);
                label.appendChild(span);
                filterTagsList.appendChild(label);
            });
        }
        
        function updateFilterTagsDisplay() {
            if (!filterTagsTrigger) return;
            filterTagsTrigger.textContent = 'üè∑Ô∏è';
        }
        
        function handleFilterAllTags() {
            if (filterAllTags.checked) {
                selectedFilterTags = [];
            } else {
                selectedFilterTags = [...tags];
            }
            updateFilterTagsDisplay();
            filterObjects();
        }
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞
        document.addEventListener('click', (e) => {
            if (!filterTagsContainer.contains(e.target)) {
                filterTagsDropdown.style.display = 'none';
            }
        });

        // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞ –∏–∑ —Å–ø–∏—Å–∫–∞ –Ω–∞ –∫–∞—Ä—Ç—É
        function moveToListToMap(objId) {
            const obj = objects.find(o => o.id === objId);
            if (!obj || !obj.listOnly) return;
            
            // –í—ã—á–∏—Å–ª—è–µ–º –ø–æ–∑–∏—Ü–∏—é –Ω–∞ –∫—Ä–∞—é –≤–∏–¥–∏–º–æ–π —á–∞—Å—Ç–∏ mapArea
            const objWidth = 150;
            const objHeight = 60;
            const containerRect = mapContainer.getBoundingClientRect();
            const margin = 20;
            
            // –ü–æ–∑–∏—Ü–∏—è –Ω–∞ –ø—Ä–∞–≤–æ–º –∫—Ä–∞—é –≤–∏–¥–∏–º–æ–π –æ–±–ª–∞—Å—Ç–∏
            const rightEdgeX = (containerRect.width - margin - offsetX) / scale - objWidth;
            const topEdgeY = (margin - offsetY) / scale;
            
            let newX = rightEdgeX;
            let newY = topEdgeY;
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –≤—ã—Ö–æ–¥–∏—Ç –ª–∏ –æ–±—ä–µ–∫—Ç –∑–∞ –≥—Ä–∞–Ω–∏—Ü—ã mapArea
            if (newX < 0) newX = 0;
            if (newY < 0) newY = 0;
            if (newX > 5000 - objWidth) newX = 5000 - objWidth;
            if (newY > 5000 - objHeight) newY = 5000 - objHeight;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—ä–µ–∫—Ç
            obj.x = newX;
            obj.y = newY;
            obj.listOnly = false; // –£–±–∏—Ä–∞–µ–º —Ñ–ª–∞–≥ "—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–ø–∏—Å–∫–∞"
            
            renderObjects();
            triggerAutoSave();
        }

        // --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ —Ä–∞–±–æ—Ç–∞ —Å Supabase ---
        async function initAuth() {
            try {
                const { data: { session } } = await supabaseClient.auth.getSession();
                if (session && session.user) {
                    currentUser = session.user;
                    onUserLoggedIn();
                }
            } catch (e) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ Supabase:', e);
            }

            const emailInput = document.getElementById('auth-email');
            const passInput = document.getElementById('auth-password');
            const btnSignup = document.getElementById('auth-signup');
            const btnLogin = document.getElementById('auth-login');
            const btnLogout = document.getElementById('auth-logout');

            if (btnSignup) btnSignup.onclick = async () => {
                const email = emailInput.value.trim();
                const password = passInput.value;
                if (!email || !password) {
                    alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
                    return;
                }
                const { error } = await supabaseClient.auth.signUp({ email, password });
                if (error) alert('–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏: ' + error.message);
                else alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ—á—Ç—É (–µ—Å–ª–∏ —Ç—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ) –∏ –≤–æ–π–¥–∏—Ç–µ.');
            };

            if (btnLogin) btnLogin.onclick = async () => {
                const email = emailInput.value.trim();
                const password = passInput.value;
                if (!email || !password) {
                    alert('–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å');
                    return;
                }
                const { data, error } = await supabaseClient.auth.signInWithPassword({ email, password });
                if (error) {
                    alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + error.message);
                    return;
                }
                currentUser = data.user;
                onUserLoggedIn();
            };

            if (btnLogout) btnLogout.onclick = async () => {
                await supabaseClient.auth.signOut();
                currentUser = null;
                const loggedOut = document.getElementById('auth-logged-out');
                const loggedIn = document.getElementById('auth-logged-in');
                if (loggedOut) loggedOut.style.display = 'flex';
                if (loggedIn) loggedIn.style.display = 'none';
            };
        }

        function onUserLoggedIn() {
            const emailSpan = document.getElementById('auth-user-email');
            if (emailSpan && currentUser) emailSpan.textContent = currentUser.email;
            const loggedOut = document.getElementById('auth-logged-out');
            const loggedIn = document.getElementById('auth-logged-in');
            if (loggedOut) loggedOut.style.display = 'none';
            if (loggedIn) loggedIn.style.display = 'flex';

            // –∫–∞–∫ —Ç–æ–ª—å–∫–æ –≤–æ—à–ª–∏ ‚Äî –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ Supabase
            loadFromSupabase();
        }

        async function saveToSupabase() {
            if (!currentUser) return;
            const payload = {
                objects,
                connections,
                version: 1
            };
            const { error } = await supabaseClient
                .from('maps')
                .upsert({
                    user_id: currentUser.id,
                    data: payload,
                    updated_at: new Date().toISOString()
                }, { onConflict: 'user_id' });
            if (error) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Supabase:', error);
            }
        }

        async function loadFromSupabase() {
            if (!currentUser) return;
            const { data, error } = await supabaseClient
                .from('maps')
                .select('data')
                .eq('user_id', currentUser.id)
                .single();

            // PGRST116 = no rows, –∑–Ω–∞—á–∏—Ç –¥–∞–Ω–Ω—ã—Ö –µ—â–µ –Ω–µ—Ç ‚Äî —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞
            if (error && error.code !== 'PGRST116') {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑ Supabase:', error);
                return;
            }

            if (data && data.data) {
                const payload = data.data;
                objects = payload.objects || [];
                connections = payload.connections || [];
                syncGlobalTags();
                updateConnectionsCount();
                renderObjects();
                // –∫—ç—à–∏—Ä—É–µ–º –ª–æ–∫–∞–ª—å–Ω–æ
                try {
                    localStorage.setItem('mapListData', JSON.stringify(payload));
                } catch (e) {
                    console.error('–û—à–∏–±–∫–∞ –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è –≤ localStorage:', e);
                }
            } else {
                // –ï—Å–ª–∏ –≤ Supabase –µ—â–µ –Ω–µ—Ç –¥–∞–Ω–Ω—ã—Ö ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ (–µ—Å–ª–∏ –±—ã–ª–∏) –∏ —Å—Ä–∞–∑—É —Å–æ—Ö—Ä–∞–Ω—è–µ–º
                if (objects.length > 0 || connections.length > 0) {
                    saveToSupabase();
                }
            }
        }
        
        // Touch-—Å–æ–±—ã—Ç–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        let touchStartX = 0, touchStartY = 0;
        let touchStartTime = 0;
        let isTouchPanning = false;
        let isTouchDragging = false;
        let lastTouchDistance = 0;
        
        function handleTouchStart(e) {
            e.preventDefault();
            if (e.touches.length === 1) {
                // –û–¥–∏–Ω –ø–∞–ª–µ—Ü - –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
                const touch = e.touches[0];
                touchStartX = touch.clientX;
                touchStartY = touch.clientY;
                touchStartTime = Date.now();
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –∫–∞—Å–∞–µ—Ç—Å—è –ª–∏ –ø–∞–ª–µ—Ü –æ–±—ä–µ–∫—Ç–∞
                const target = document.elementFromPoint(touch.clientX, touch.clientY);
                const mapObject = target?.closest('.map-object');
                
                if (mapObject) {
                    // –ö–∞—Å–∞–µ–º—Å—è –æ–±—ä–µ–∫—Ç–∞ - –Ω–∞—á–∏–Ω–∞–µ–º –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                    isTouchDragging = true;
                    const objId = parseInt(mapObject.dataset.id);
                    selectedObject = objects.find(obj => obj.id === objId);
                    if (selectedObject) {
                        startGroupDrag(e, objId);
                    }
                } else {
                    // –ö–∞—Å–∞–µ–º—Å—è –ø—É—Å—Ç–æ–≥–æ –º–µ—Å—Ç–∞ - –Ω–∞—á–∏–Ω–∞–µ–º –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ
                    isTouchPanning = true;
                    startPan(e);
                }
            } else if (e.touches.length === 2) {
                // –î–≤–∞ –ø–∞–ª—å—Ü–∞ - –∑—É–º
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                lastTouchDistance = Math.sqrt(
                    Math.pow(touch2.clientX - touch1.clientX, 2) + 
                    Math.pow(touch2.clientY - touch1.clientY, 2)
                );
            }
        }
        
        function handleTouchMove(e) {
            e.preventDefault();
            
            if (e.touches.length === 1 && (isTouchPanning || isTouchDragging)) {
                // –û–¥–∏–Ω –ø–∞–ª–µ—Ü - –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –ø–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–ª–∏ –ø–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ
                const touch = e.touches[0];
                const deltaX = touch.clientX - touchStartX;
                const deltaY = touch.clientY - touchStartY;
                
                if (isTouchDragging && selectedObject) {
                    // –ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞
                    const dx = deltaX / scale;
                    const dy = deltaY / scale;
                    selectedObject.x += dx;
                    selectedObject.y += dy;
                    touchStartX = touch.clientX;
                    touchStartY = touch.clientY;
                    renderObjects();
                    updateConnectionLines(selectedObject.id);
                } else if (isTouchPanning) {
                    // –ü–∞–Ω–æ—Ä–∞–º–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞—Ä—Ç—ã
                    handlePan(e);
                }
            } else if (e.touches.length === 2) {
                // –î–≤–∞ –ø–∞–ª—å—Ü–∞ - –∑—É–º
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                const currentDistance = Math.sqrt(
                    Math.pow(touch2.clientX - touch1.clientX, 2) + 
                    Math.pow(touch2.clientY - touch1.clientY, 2)
                );
                if (lastTouchDistance > 0) {
                    const delta = (currentDistance - lastTouchDistance) / 100;
                    const newScale = Math.max(0.2, Math.min(3, scale + delta));
                    if (newScale !== scale) {
                        // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ –º–µ–∂–¥—É –ø–∞–ª—å—Ü–∞–º–∏
                        const centerX = (touch1.clientX + touch2.clientX) / 2;
                        const centerY = (touch1.clientY + touch2.clientY) / 2;
                        const rect = mapContainer.getBoundingClientRect();
                        const worldX = (centerX - offsetX) / scale;
                        const worldY = (centerY - offsetY) / scale;
                        scale = newScale;
                        offsetX = centerX - worldX * scale;
                        offsetY = centerY - worldY * scale;
                        mapArea.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
                    }
                }
                lastTouchDistance = currentDistance;
            }
        }
        
        function handleTouchEnd(e) {
            e.preventDefault();
            
            if (e.touches.length === 0) {
                // –í—Å–µ –ø–∞–ª—å—Ü—ã —É–±—Ä–∞–Ω—ã
                if (isTouchPanning) {
                    endPan();
                    isTouchPanning = false;
                }
                if (isTouchDragging) {
                    endDrag();
                    isTouchDragging = false;
                }
                lastTouchDistance = 0;
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞ tap (–∫–æ—Ä–æ—Ç–∫–æ–µ –∫–∞—Å–∞–Ω–∏–µ)
                const touchDuration = Date.now() - touchStartTime;
                if (touchDuration < 300) {
                    // –≠—Ç–æ –±—ã–ª tap - –æ—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    const touch = e.changedTouches[0];
                    const target = document.elementFromPoint(touch.clientX, touch.clientY);
                    const mapObject = target?.closest('.map-object');
                    
                    if (mapObject && !target.classList.contains('map-object-delete') && 
                        !target.classList.contains('map-object-connector')) {
                        const objId = parseInt(mapObject.dataset.id);
                        openEditModal(objId);
                    }
                }
            }
        }
        
        // –ó—É–º —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏
        function handleZoomButton(delta) {
            const newScale = Math.max(0.2, Math.min(3, scale + delta));
            if (newScale !== scale) {
                // –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—Ç—Ä–∞ —ç–∫—Ä–∞–Ω–∞
                const rect = mapContainer.getBoundingClientRect();
                const centerX = rect.width / 2;
                const centerY = rect.height / 2;
                const worldX = (centerX - offsetX) / scale;
                const worldY = (centerY - offsetY) / scale;
                scale = newScale;
                offsetX = centerX - worldX * scale;
                offsetY = centerY - worldY * scale;
                mapArea.style.transform = `translate(${offsetX}px, ${offsetY}px) scale(${scale})`;
            }
        }

        // –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è —Å–º–µ–Ω–∞ –∏–∫–æ–Ω–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–µ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è —Ä–µ–∂–∏–º–∞
        function updateToggleViewIcon() {
            if (isMapView) {
                toggleViewBtn.textContent = 'üó∫Ô∏è';
            } else {
                toggleViewBtn.textContent = 'üìã';
            }
        }
        updateToggleViewIcon();
    </script>
</body>
</html>